---
title: "Exploration of Red Wine Composition"
author: "by Fernando Maletski"
output: html_document
---
***
```{r setup, echo=FALSE, message=FALSE, warning=FALSE}
data <- read.csv('./data/wineQualityReds.csv', header = 1)
data <- data[, -1] # Removes useless UID
library(knitr)
library(dplyr)
library(ggplot2)
library(GGally)
library(gridExtra)
library(scales)
#install.packages('ggiraphExtra')
library(ggiraphExtra)
#install.packages('corrgram')
library(corrgram)
library(RColorBrewer)
library(memisc)
#install.packages('DAAG')
library(DAAG)
#install.packages('e1071')
library(e1071)
```

  This project aims to shed a light on how the chemical composition of a red wine affect it's quality, measured by a median sensory score from at least 3 wine tasting experts.


#### The dataset was provided by:

  P. Cortez, A. Cerdeira, F. Almeida, T. Matos and J. Reis. 
  Modeling wine preferences by data mining from physicochemical properties.
  In Decision Support Systems, Elsevier, 47(4):547-553. ISSN: 0167-9236.

  Available at: [@Elsevier] http://dx.doi.org/10.1016/j.dss.2009.05.016
                [Pre-press (pdf)] http://www3.dsi.uminho.pt/pcortez/winequality09.pdf
                [bib] http://www3.dsi.uminho.pt/pcortez/dss09.bib


***
# Univariate Plots Section

  Here we'll be taking a look at the various variables in the dataset, with a brief description, and histograms showing the count of data points.


### Dataset Dimentions

```{r echo=FALSE}
dim(data)
```

  We have 1599 data points with 12 variables.


### Dataset Structure

```{r echo=FALSE}
str(data)
```

### Dataset Summary

```{r echo=FALSE}
summary(data)
```

### Output variable, quality

  Quality was measured by at least 3 wine experts who graded each wine using a score that goes from 0 (very bad) to 10 (very excellent). The value present in the dataset is the median of those scores.
  
  As we can see in the summary above, the quality scores in the dataset actually ranges from 3 to 8.

```{r echo=FALSE}
ggplot(aes(quality), data = data) +
  geom_histogram(bins = 6, fill = 'darkred') +
  scale_x_continuous(breaks = seq(1, 10, 1))
```

  As we can see in the summary above and on the plot, the quality scores in the dataset actually ranges from 3 to 8, normally distributed, with most scores ranging from 5 to 7, there is no decimal value.

### Fixed Acidity

  The quantity, in grams per liter (g/dm^3), of nonvolatile acids.
  
  
```{r echo = FALSE}
ggplot(aes(fixed.acidity), data = data) +
  geom_histogram(bins = 50, fill = 'darkred') +
  scale_x_continuous(breaks = seq(0, 20, 1))
```

  Again we have a normally distributed variable, but this time, there's a few outliers (values above 13.5), with a mode at around 7.5.
  
### Volatile Acidity

  The amount of acetic acid, in grams per liter (g/dm^3). This acid in high quantities lead to the unpleasant, vinegar taste found in some wines.
  
```{r echo = FALSE}
ggplot(aes(volatile.acidity), data = data) +
  geom_histogram(bins = 50, fill = 'darkred') +
  scale_x_continuous(breaks = seq(0, 2, 0.1))
```

  Most wines have between 0.3 and 0.8 grams per liter, with very few above the 1.0 mark. It's a bi modal normal distribution with 0.4 and 0.6 as modes.

### Citric Acid

  Measured in grams per liter (g/dm^3). Present in small quantities, citric acid adds a "freshness" and citric flavor to the wine.

```{r echo = FALSE}
ggplot(aes(citric.acid), data = data) +
  geom_histogram(bins = 100, fill = 'darkred') +
  scale_x_continuous(breaks = seq(0, 20, 0.05))
```

 We have a pretty even, slightly positively skewed distribution. Is of note, that there's 2 clear spikes, at 0 and around 0.5 grams per liter.
 
### Residual Sugar

  The quantity of sugar remaining after the fermentation stops, in grams per liter (g/dm^3). It's rare to find wines with less than 1 g/liter and above 45 they are considered "sweet".

```{r echo = FALSE}
ggplot(aes(residual.sugar), data = data) +
  geom_histogram(bins = 50, fill = 'darkred') +
  scale_x_continuous(breaks = seq(0, 100, 1))
```

  Most wines have between 1 and 3 grams per liter. We have no "sweet" wines in our dataset.

```{r echo = FALSE}
ggplot(aes(residual.sugar), data = data) +
  geom_histogram(bins = 30, fill = 'darkred') +
  scale_x_continuous(breaks = seq(0, 100, 0.5), limits=c(0, 7))
```
  
  Zooming in to between 0 and 7 we can see a high concentration of values between 1.5 and 2.5.
  
### Chlorides

  The amount of salt (sodium chloride), in grams per liter (g/dm^3).
  
```{r echo = FALSE}
ggplot(aes(chlorides), data = data) +
  geom_histogram(bins = 100, fill = 'darkred') +
  scale_x_continuous(breaks = seq(0, 1, 0.05))
```

  Very few observations below 0.025 and above 0.125 grams per liter.
  
```{r echo = FALSE}
ggplot(aes(chlorides), data = data) +
  geom_histogram(bins = 50, fill = 'darkred') +
  scale_x_continuous(breaks = seq(0, 1, 0.01), limits = c(0, 0.15))
```
  
  Discarding values above 0.15 we have a textbook normal distribution with a mode at 0.075
  

### Free Sulfur Dioxide

  Free form SO2 exists in equilibrium between molecular SO2 (as a dissolved gas) and bisulfite ion. Prevents microbial growth and the oxidation of wine. But concentrations of over 50 ppm (roughly 50 mg/L, considering the density the same as water) becomes evident in the taste and the bouquet (smell) of the wine.
  
  Measured in milligrams per liter (mg/dm^3).

```{r echo = FALSE}
ggplot(aes(free.sulfur.dioxide), data = data) +
  geom_histogram(bins = 50, fill = 'darkred') +
  scale_x_continuous(breaks = seq(0, 100, 5))
```

  Very few exceed the 'taste threshold' of 50 ppm, but we can expect a great impact on the score of these wines. The distribution is negatively skewed.

### Total Sulfur Dioxide

  The total amount of SO2, free and bound in milligrams per liter (mg/dm^3). The impact on the score should be less evident than its free counterpart.

```{r echo = FALSE}
ggplot(aes(total.sulfur.dioxide), data = data) +
  geom_histogram(bins = 50, fill = 'darkred') +
  scale_x_continuous(breaks = seq(0, 300, 15))
```

  Most data points have less than 120 mg/L. And we have a few outliers above the 270 mg/L mark. Again, we have a negatively skewed distribution.
  
### Density

  The density of the wine may be closer to that of water (1 kg/L) depending on the alcohol and sugar content. This variable is measured in kilograms per liter (kg/L)
  
```{r echo = FALSE}
ggplot(aes(density), data = data) +
  geom_histogram(bins = 50, fill = 'darkred') +
  scale_x_continuous(breaks = seq(0, 2, 0.001))
```
  
  The majority of wines are a little bit less dense than water (kg/L), but there is a few exceptions. Sugar tends to make the wine more dense and alcohol less dense. We will be using this variable, multiplied with the Free Sulfur Dioxide one to convert it to ppm so we can accurately compare it with the 50 ppm threshold from the dataset documentation:
  
```{r echo = FALSE}
data$free.sulfur.ppm <- data$free.sulfur.dioxide * data$density
summary(data$free.sulfur.ppm)
data <- data[, c('fixed.acidity', 'volatile.acidity', 'citric.acid', 
                 'residual.sugar', 'chlorides', 'free.sulfur.dioxide', 
                 'free.sulfur.ppm', 'total.sulfur.dioxide', 'density', 
                 'pH', 'sulphates', 'alcohol', 'quality')]
```

```{r echo = FALSE}
ggplot(aes(free.sulfur.ppm), data = data) +
  geom_histogram(bins = 50, fill = 'darkred') +
  scale_x_continuous(breaks = seq(0, 100, 5)) +
  geom_vline(aes(xintercept=50))
```

  As expected, the plot is very similar, but using the correct units is important to not make hasty assumptions.
  
### pH

  pH is a very well known numeric scale to specify the acidity or basicity of a liquid. It usually ranges from 0 (very acidic) to 14 (very basic), but can exceed those values on extreme cases.
  
```{r echo = FALSE}
ggplot(aes(pH), data = data) +
  geom_histogram(bins = 30, fill = 'darkred') +
  scale_x_continuous(breaks = seq(0, 14, 0.1))
```

  We have a nice normal distribution with most wines between 3 and 3.6 on the pH scale.
  
### Sulphates

  Sulphates are wine additives that contribute to the sulfur dioxide (SO2) levels. SO2 is necessary because it acts as an antimicrobial and antioxidant, preserving the wine. This variable is in grams per liter (g/dm3)
  
```{r echo = FALSE}
ggplot(aes(sulphates), data = data) +
  geom_histogram(bins = 40, fill = 'darkred') +
  scale_x_continuous(breaks = seq(0, 3, 0.1))
```

  Very few wines exceed the 1.2 g/L mark, they can be considered outliers. This variable is approximately normally distributed with the mode at 0.6 g/L.
  
### Alcohol

  And last, but definitely not least, alcohol content in percent by volume.
  
```{r echo = FALSE}
ggplot(aes(alcohol), data = data) +
  geom_histogram(bins = 40, fill = 'darkred') +
  scale_x_continuous(breaks = seq(0, 100, 1))
```

Very few wines have less than 9 % alcohol, the rest are in a negatively skewed distribution peaking at around 9.5 %.

### Wine Profile by Quality

  As we have very few wines of the best (18) and worst (10) quality available, makes sense to expand the bins to include more scores:
```{r echo = FALSE}
table(data$quality)
```  
  
  If we isolate the best (quality = 7 and 8) and worst (quality = 3 and 4) wines in our dataset we can have three profiles of wines:
  
* Worst wines: Quality = 3 and 4
* Average wines: Quality = 5 and 6
* Best wines: Quality = 7 and 8

```{r echo = FALSE}
data$quality.bins <- cut(data$quality, breaks = c(0,4,6,10), 
                         labels = c('worst', 'average', 'best'))
table(data$quality.bins)
```

  A radar plot using those profiles can help us identify trends in the data. We'll be using the ppm (parts per million) version of the 'Free Sulfur Dioxide' variable:
  
```{r echo = FALSE}
ggRadar(data = subset(data, select = -c(quality, free.sulfur.dioxide)), 
        aes(colour = quality.bins), size = 1.5, alpha = 0.5)
```

  As we have significant outliers in the following variables: sulphates, total sulfur dioxide, chlorides and residual sugar, taking the mean of all the variables in the groups and normalizing the results to between 0.5 ,for the lowest value, and 1.0, for the highest, can further help identifying the trends. It is important to say that doing so we lose some dimensionality information, but trends tend to be clearer:


```{r echo = FALSE}
bestwines.means <- summarise(subset(data, quality >= 7),
                             fixed.acidity = mean(fixed.acidity),
                             volatile.acidity = mean(volatile.acidity),
                             citric.acid = mean(citric.acid),
                             residual.sugar = mean(residual.sugar),
                             chlorides = mean(chlorides),
                             free.sulfur.ppm = mean(free.sulfur.ppm),
                             total.sulfur.dioxide = mean(total.sulfur.dioxide),
                             density = mean(density),
                             pH = mean(pH),
                             sulphates = mean(sulphates),
                             alcohol = mean(alcohol),
                             quality.bins = 'best'
                             )
worstwines.means <- summarise(subset(data, quality <= 4),
                             fixed.acidity = mean(fixed.acidity),
                             volatile.acidity = mean(volatile.acidity),
                             citric.acid = mean(citric.acid),
                             residual.sugar = mean(residual.sugar),
                             chlorides = mean(chlorides),
                             free.sulfur.ppm = mean(free.sulfur.ppm),
                             total.sulfur.dioxide = mean(total.sulfur.dioxide),
                             density = mean(density),
                             pH = mean(pH),
                             sulphates = mean(sulphates),
                             alcohol = mean(alcohol),
                             quality.bins = 'worst'
                             )
data.means <- summarise(subset(data, quality >= 5 && quality <=6),
                             fixed.acidity = mean(fixed.acidity),
                             volatile.acidity = mean(volatile.acidity),
                             citric.acid = mean(citric.acid),
                             residual.sugar = mean(residual.sugar),
                             chlorides = mean(chlorides),
                             free.sulfur.ppm = mean(free.sulfur.ppm),
                             total.sulfur.dioxide = mean(total.sulfur.dioxide),
                             density = mean(density),
                             pH = mean(pH),
                             sulphates = mean(sulphates),
                             alcohol = mean(alcohol),
                             quality.bins = 'average'
                             )
means <- rbind(data.means, bestwines.means, worstwines.means)
means$quality.bins <- factor(means$quality.bins, 
                             levels = c('worst', 'average', 'best'))


means$fixed.acidity <- rescale(means$fixed.acidity, to = c(0.5,1))
means$volatile.acidity <- rescale(means$volatile.acidity, to = c(0.5,1))
means$citric.acid <- rescale(means$citric.acid, to = c(0.5,1))
means$residual.sugar <- rescale(means$residual.sugar, to = c(0.5,1))
means$chlorides <- rescale(means$chlorides, to = c(0.5,1))
means$free.sulfur.ppm <- rescale(means$free.sulfur.ppm, to = c(0.5,1))
means$total.sulfur.dioxide <- rescale(means$total.sulfur.dioxide, to = c(0.5,1))
means$density <- rescale(means$density, to = c(0.5,1))
means$pH <- rescale(means$pH, to = c(0.5,1))
means$sulphates <- rescale(means$sulphates, to = c(0.5,1))
means$alcohol <- rescale(means$alcohol, to = c(0.5,1))

ggRadar(data = means, aes(color = quality.bins), rescale = FALSE, size = 1.5, 
        ylim = c(0, 1))
```
***

# Univariate Analysis

### What is the structure of your dataset?

There are 1599 red wines in the dataset with 12 variables, one of them, quality is the output variable, in other words, we will be trying to determine which variables have an effect, and which effect it is, in the quality of the wine. Preliminary analysis has the variables split in three different groups:

* Positive effect - Variables that tend to increase the quality of the wines as they increase, to a limit of course (we will study the outliers later on).
    + Fixed Acidity
    + Citric Acid
    + Sulphates
    + Alcohol
* Negative effect - Variables that tend to have the opposite effect, decreasing the quality of the wine as they increase:
    + Volatile Acidity
    + Chlorides
    + pH
* Undetermined effect - Variables that we can't classify still, maybe they have a more complicated relationship (for example, increasing the quality up until a certain value), further investigation is necessary:
    + Residual Sugar
    + Free Sulfur Dioxide (ppm)
    + Total Sulfur Dioxide
    + Density
  
Further investigation is necessary to confirm these hypothesis and to better understand the "Undetermined effect" variables.

Other observations:

* There is no "perfect wine", quality actually ranges between 3 and 8, with most wines scoring 5 and 6 (1319).
* Four variables have significant outliers:
    + Sulphates
    + Total Sulfur Dioxide
    + Chlorides
    + Residual Sugar
* With the exception of "Citric Acid", "Free Sulfur Dioxide", "Total Sulfur Dioxide" and "Alcohol", the variables tend to be normally distributed, or pretty close to it.
* "Free Sulfur Dioxide", "Total Sulfur Dioxide" and "Alcohol" are positively skewed.
* "Citric Acid" have a pretty even distribution, a bit positively skewed. There is 2 pronounced spikes at 0 and around 0.5.

### What is/are the main feature(s) of interest in your dataset?

The main feature is quality. This exploration objective is to determine how and which other variables have an effect on it. Choosing the right variables, i suspect a linear model could be created to predict the quality based on the remaining variables.

### What other features in the dataset do you think will help support your investigation into your feature(s) of interest?

  As stated in the first question, all the variables seems to have an effect on quality, albeit differently, there are variables with positive, negative and yet undetermined effects. Further investigation is necessary to confirm this hypothesis and to clarify the undetermined variables.

  One point of interest that needs a deeper analysis is the relationship between variables. For example, in the documentation of the dataset is stated that sugar and alcohol have an effect on density, so it is important in investigate if density can be treated as an independent variable as is necessary to use it on a linear model (regression). The same can be said to sulphates, free and total sulfur dioxide.
  
### Did you create any new variables from existing variables in the dataset?

Two: 
* The first, Free Sulfur Dioxide (ppm), is the result of the multiplication of two other variables, free sulfur dioxide (mg/L) and density. I created this variable because there was mentioned in the dataset documentation that at levels above 50 ppm, free SO2 becomes evident in the taste and smell of the wine, and I'll be using it, instead of the mg/L version, for the rest of the analysis.

* The second one is more of a classification of quality then a new variable. It has three possible values:
    + worst: Quality = 3 and 4
    + average: Quality = 5 and 6
    + best: Quality = 7 and 8

### Of the features you investigated, were there any unusual distributions? Did you perform any operations on the data to tidy, adjust, or change the form of the data? If so, why did you do this?

There was two variable with such pronounced outliers that I had to zoom in the plot to have a better understanding of them: residual sugar and chlorides. You could say that citric acid has a weird distribution, being somewhat even and with two spikes, but I didn't need to perform any transformations to better understand it.

***
# Bivariate Plots Section

Here we'll be looking into the relationship between the variables, and dig deeper into the relationship of each one of them and the quality.

```{r echo=FALSE}
panel.shadeNtext <- function (x, y, corr = NULL, col.regions, ...) 
{
  corr <- cor(x, y, use = "pair")
  results <- cor.test(x, y, alternative = "two.sided")
  est <- results$p.value

  ncol <- 14
  pal <- col.regions(ncol)
  col.ind <- as.numeric(cut(corr, breaks = seq(from = -1, to = 1, 
                                               length = ncol + 1), 
                            include.lowest = TRUE))
  usr <- par("usr")
  rect(usr[1], usr[3], usr[2], usr[4], col = pal[col.ind], 
       border = NA)
  box(col = "lightgray")
  on.exit(par(usr))
  par(usr = c(0, 1, 0, 1))
  r <- formatC(corr, digits = 2, format = "f")
  cex.cor <- .8/strwidth("-X.xx")
  text(0.5, 0.4, paste0(r), cex = cex.cor)
}


corrgram(subset(data, select = -c(free.sulfur.dioxide))[,1:12], order = 'PCA', 
         lower.panel=panel.shadeNtext, upper.panel=panel.shadeNtext, 
         text.panel=panel.txt, label.srt = -30)
```

This correlation (Pearson's) diagram helps identifying the most correlated variables in our dataset. Using the color scheme of blue for positive correlations and red for negative and applying a PCA (principal component analysis) to reorder the variables, it becomes easy to see which variables have a relationship, and how strong it is. A few observations:

* Unsurprisingly, the most correlated variables in the dataset are pH and Fixed Acidity (-0.68) as pH is a scale to measure the overall acidity of liquids. pH is also moderately correlated with citric acid (-0.54). The surprise here is that Volatile Acidity have an small positive effect on pH.

* According to the documentation that came with the dataset, Density should be strongly affected by Alcohol and Residual Sugar. While the first do present an expected "high" negative correlation (for the dataset, it's more like moderate as far as correlations go), Sugar exhibit a weaker relationship to Density (0.36, along with Citric Acid) than Fixed Acidity (0.67). This last variable actually has the strongest relationship with Density in the dataset.

* Another expected "high" correlated relationship is Total Sulfur Dioxide and Free Sulfur Dioxide (0.67).

* One surprising result is that Volatile Acidity is negatively correlated with Citric Acid (-0.55) and Fixed Acidity (-0.26). What is not surprising is that it has the biggest negative effect on Quality (-0.39) of all the variables, nobody likes wine that tastes like vinegar!

* A strange result is that Sulphates doesn't appear to be correlated with Total (0.04) and Free Sulfur Dioxide (0.05), as whole point of having it, as it is an additive, is to increase the SO2 levels. One possible explanation for this is that Sulphates are only added to wines with poor naturally occurring levels of SO2, that would explain why Sulphates have a positive effect on Quality (0.25) too.

### Quality

As for Quality, our main variable of interest, a closer look is warranted, here's the correlations between it and all the variables, ordered from positive to negative:

```{r echo=FALSE}
cor.matrix <- cor(subset(data, select = -c(free.sulfur.dioxide))[,1:12])
cor.matrix <- round(cor.matrix, 2)
sort(cor.matrix[,'quality'], decreasing = TRUE)[2:12]
```

Here are the r^2 (r-squared) values, this statistic measures how much (in %) a variable explains the other:

```{r echo=FALSE}
r2.matrix <- cor.matrix * cor.matrix * 100
r2.matrix <- round(r2.matrix, 2)
sort(r2.matrix[,'quality'], decreasing = TRUE)[2:12]
```


#### Positive

* Alcohol, Sulphates, Citric Acid and Fixed Acidity have a positive correlation with quality. The relationship is weak, with the exception of Alcohol (moderate). This result confirms the findings of the previous analysis. The order of the following plots is from the most positively correlated to the least:
  
```{r echo=FALSE}
p1 <- ggplot(data = data, aes(x = quality, y = alcohol, 
                              fill = quality.bins)) + 
  geom_jitter(alpha = 0.1) +
  geom_boxplot(alpha = 0.7) +
  guides(fill=FALSE) +
  scale_x_continuous(breaks = seq(0, 10, 1))

p2 <- ggplot(data = data, aes(x = quality, y = sulphates, 
                              fill = quality.bins)) + 
  geom_jitter(alpha = 0.1) +
  geom_boxplot(alpha = 0.7) +
  guides(fill=FALSE) +
  scale_x_continuous(breaks = seq(0, 10, 1))

p3 <- ggplot(data = data, aes(x = quality, y = citric.acid, 
                              fill = quality.bins)) + 
  geom_jitter(alpha = 0.1) +
  geom_boxplot(alpha = 0.7) +
  guides(fill=FALSE) +
  scale_x_continuous(breaks = seq(0, 10, 1))

p4 <- ggplot(data = data, aes(x = quality, y = fixed.acidity, 
                              fill = quality.bins)) + 
  geom_jitter(alpha = 0.1) +
  geom_boxplot(alpha = 0.7) +
  guides(fill=FALSE) +
  scale_x_continuous(breaks = seq(0, 10, 1))

grid.arrange(p1, p2, p3, p4, ncol=2)
``` 

These plots just illustrate what we found out so far. The overlaying box plots represent the bins (best, average and worst wines) created beforehand. I've omitted the legends to reduce clutter as they are not necessary with the quality printed on the bottom of each plot.

```{r echo=FALSE}
p1 <- ggplot(data = data, aes(x = quality, y = alcohol, group = quality, 
                              fill = quality.bins)) + 
  geom_jitter(alpha = 0.1) +
  geom_boxplot(alpha = 0.7) +
  guides(fill=FALSE) +
  scale_x_continuous(breaks = seq(0, 10, 1))

p2 <- ggplot(data = data, aes(x = quality, y = sulphates, group = quality, 
                              fill = quality.bins)) + 
  geom_jitter(alpha = 0.1) +
  geom_boxplot(alpha = 0.7) +
  guides(fill=FALSE) +
  scale_x_continuous(breaks = seq(0, 10, 1))

p3 <- ggplot(data = data, aes(x = quality, y = citric.acid, group = quality, 
                              fill = quality.bins)) + 
  geom_jitter(alpha = 0.1) +
  geom_boxplot(alpha = 0.7) +
  guides(fill=FALSE) +
  scale_x_continuous(breaks = seq(0, 10, 1))

p4 <- ggplot(data = data, aes(x = quality, y = fixed.acidity, group = quality, 
                              fill = quality.bins)) + 
  geom_jitter(alpha = 0.1) +
  geom_boxplot(alpha = 0.7) +
  guides(fill=FALSE) +
  scale_x_continuous(breaks = seq(0, 10, 1))

grid.arrange(p1, p2, p3, p4, ncol=2)
``` 

Breaking up the groups, we can see a nice and somewhat linear positive relationship between Quality and Citric Acid, and Quality and Sulphates. Fixed Acidity increases up until Quality = 7, then the median drops slightly, but the interquartile range (IQR) is bigger. Alcohol levels do not increase before we reach Quality = 6, meaning that even the most positively correlated variable can't save a really bad wine!
  
#### Negative 
  
* Volatile Acidity, Total Sulfur Dioxide, Density and Chlorides have a negative correlation. The worst thing for a wine is Volatile Acidity as previously stated. This time the results are different from the previous analysis, so I'll investigate the variable found to have a negative effect before, pH, afterwards. The order of the plots is from the most negatively correlated to the least:

```{r echo=FALSE}
p1 <- ggplot(data = data, aes(x = quality, y = volatile.acidity, 
                              fill = quality.bins)) + 
  geom_jitter(alpha = 0.1) +
  geom_boxplot(alpha = 0.7) +
  guides(fill=FALSE) +
  scale_x_continuous(breaks = seq(0, 10, 1))

p2 <- ggplot(data = data, aes(x = quality, y = total.sulfur.dioxide, 
                              fill = quality.bins)) + 
  geom_jitter(alpha = 0.1) +
  geom_boxplot(alpha = 0.7) +
  guides(fill=FALSE) +
  scale_x_continuous(breaks = seq(0, 10, 1))

p3 <- ggplot(data = data, aes(x = quality, y = density, fill = quality.bins)) + 
  geom_jitter(alpha = 0.1) +
  geom_boxplot(alpha = 0.7) +
  guides(fill=FALSE) +
  scale_x_continuous(breaks = seq(0, 10, 1))

p4 <- ggplot(data = data, aes(x = quality, y = chlorides, fill = quality.bins)) + 
  geom_jitter(alpha = 0.1) +
  geom_boxplot(alpha = 0.7) +
  guides(fill=FALSE) +
  scale_x_continuous(breaks = seq(0, 10, 1))

grid.arrange(p1, p2, p3, p4, ncol=2)
``` 
    
The outliers in the Total Sulfur Dioxide and Clorides variables makes the plots really hard to interpret, removing values exceeding 200 and 0.2, respectively, helps:

```{r echo=FALSE, warning=FALSE}
p1 <- ggplot(data = data, aes(x = quality, y = total.sulfur.dioxide, 
                              fill = quality.bins)) + 
  geom_jitter(alpha = 0.1) +
  geom_boxplot(alpha = 0.7) +
  guides(fill=FALSE) +
  scale_x_continuous(breaks = seq(0, 10, 1)) +
  scale_y_continuous(limits = c(0, 200))

p2 <- ggplot(data = data, aes(x = quality, y = chlorides, fill = quality.bins)) + 
  geom_jitter(alpha = 0.1) +
  geom_boxplot(alpha = 0.7) +
  guides(fill=FALSE) +
  scale_x_continuous(breaks = seq(0, 10, 1)) +
  scale_y_continuous(limits = c(0, 0.2))

grid.arrange(p1, p2, ncol=2)
``` 

With the exception of Volatile Acidity, it doesn't appear to be a linear relationship between these variables and quality, maybe breaking up the groups helps (I'll keep the limits for Total Sulfur Dioxide and Chlorides):



```{r echo=FALSE, warning=FALSE}
p1 <- ggplot(data = data, aes(x = quality, y = volatile.acidity, 
                              group = quality, fill = quality.bins)) + 
  geom_jitter(alpha = 0.1) +
  geom_boxplot(alpha = 0.7) +
  guides(fill=FALSE) +
  scale_x_continuous(breaks = seq(0, 10, 1))

p2 <- ggplot(data = data, aes(x = quality, y = total.sulfur.dioxide, 
                              group = quality, fill = quality.bins)) + 
  geom_jitter(alpha = 0.1) +
  geom_boxplot(alpha = 0.7) +
  guides(fill=FALSE) +
  scale_x_continuous(breaks = seq(0, 10, 1)) +
  scale_y_continuous(limits = c(0, 200))

p3 <- ggplot(data = data, aes(x = quality, y = density, group = quality, 
                              fill = quality.bins)) + 
  geom_jitter(alpha = 0.1) +
  geom_boxplot(alpha = 0.7) +
  guides(fill=FALSE) +
  scale_x_continuous(breaks = seq(0, 10, 1))

p4 <- ggplot(data = data, aes(x = quality, y = chlorides, group = quality, 
                              fill = quality.bins)) + 
  geom_jitter(alpha = 0.1) +
  geom_boxplot(alpha = 0.7) +
  guides(fill=FALSE) +
  scale_x_continuous(breaks = seq(0, 10, 1)) +
  scale_y_continuous(limits = c(0, 0.2))

grid.arrange(p1, p2, p3, p4, ncol=2)
``` 

The variables have a negative, mostly linear relationship with quality, except Total Sulfur Dioxide, that similarly to what occurred with Alcohol, have a strange behavior up until a threshold, in this case, Quality = 5, so having low levels of SO2 can't save a bad wine. Now, the strange case, pH:

```{r echo=FALSE}
p1 <- ggplot(data = data, aes(x = quality, y = pH, fill = quality.bins)) + 
  geom_jitter(alpha = 0.1) +
  geom_boxplot(alpha = 0.7) +
  guides(fill=FALSE) +
  scale_x_continuous(breaks = seq(0, 10, 1))

p2 <- ggplot(data = data, aes(x = quality, y = pH, group = quality, 
                              fill = quality.bins)) + 
  geom_jitter(alpha = 0.1) +
  geom_boxplot(alpha = 0.7) +
  guides(fill=FALSE) +
  scale_x_continuous(breaks = seq(0, 10, 1))

grid.arrange(p1, p2, ncol=2)
``` 

Even without a meaningful correlation score, it's evident that higher pH has a negative impact on quality.

#### Undetermined

Here we will take a look at the variables that have yet to exhibit a meaningful relationship with quality: Residual Sugar and Free Sulfur Dioxide (ppm).

```{r echo=FALSE}
p1 <- ggplot(data = data, aes(x = quality, y = residual.sugar, 
                              fill = quality.bins)) + 
  geom_jitter(alpha = 0.1) +
  geom_boxplot(alpha = 0.7) +
  guides(fill=FALSE) +
  scale_x_continuous(breaks = seq(0, 10, 1)) +
  scale_y_log10()

p2 <- ggplot(data = data, aes(x = quality, y = residual.sugar, group = quality, 
                              fill = quality.bins)) + 
  geom_jitter(alpha = 0.1) +
  geom_boxplot(alpha = 0.7) +
  guides(fill=FALSE) +
  scale_x_continuous(breaks = seq(0, 10, 1)) +
  scale_y_log10()

grid.arrange(p1, p2, ncol=2)
``` 

I've scaled the Y axis logaritimically (log10) as the values of Residual Sugar have a great range, but the many of the highest ones can be considered outliers. As expected, there's no meaningful relationship between it and Quality, the values are all over the place.

```{r echo=FALSE}
p1 <- ggplot(data = data, aes(x = quality, y = free.sulfur.ppm, 
                              fill = quality.bins)) + 
  geom_jitter(alpha = 0.1) +
  geom_boxplot(alpha = 0.7) +
  guides(fill=FALSE) +
  scale_x_continuous(breaks = seq(0, 10, 1)) +
  geom_hline(yintercept = 50)

p2 <- ggplot(data = data, aes(x = quality, y = free.sulfur.ppm, 
                              group = quality, fill = quality.bins)) + 
  geom_jitter(alpha = 0.1) +
  geom_boxplot(alpha = 0.7) +
  guides(fill=FALSE) +
  scale_x_continuous(breaks = seq(0, 10, 1)) +
  geom_hline(yintercept = 50)

grid.arrange(p1, p2, ncol=2)
``` 

Even though we didn't find an relationship between Free Sulfur Dioxide and Quality up until now, these plots explain why. Having "low" amounts of free SO2 is good for the very best wines, but the ones that are not that great actually benefit from having the antioxidant and antibacterial effects of SO2. The information found in the documentation about concentrations above 50 ppm of free SO2 becoming evident in the smell and taste of wine doesn't appear to pay off until we're studying the very best wines (quality = 8).

***

# Bivariate Analysis

### Talk about some of the relationships you observed in this part of the investigation. How did the feature(s) of interest vary with other features in the dataset?

The most correlated variables with quality are Alcohol (positively) and Volatile Acidity (negatively), but as far as correlation (Pearson's) values go, the relationship could be called moderate at best. According with the r^2 statistic, they explain the variation in the quality by 23.04% and 15.21% respectively. Most variables exhibit a weak correlation with quality or none at all.


But still, we can further expand the classification of the variables the variables (now in order of strength of relationship):

* Positive effect - Variables that tend to increase the quality of the wines as they increase, to a limit of course (we will study the outliers later on).
    + Alcohol
    + Citric Acid
    + Sulphates
    + Fixed Acidity

* Negative effect - Variables that tend to have the opposite effect, decreasing the quality of the wine as they increase:
    + Volatile Acidity
    + Total Sulfur Dioxide *
    + Density
    + Chlorides
    + pH
    + Free Sulfur Dioxide * 
    
(*) Those variables have a strange relationship with quality until a threshold is met (quality = 5)

* Undetermined effect - Variables that doesn't appear to affect the quality:
    + Residual Sugar


### Did you observe any interesting relationships between the other features (not the main feature(s) of interest)?

Yes. Here's some observations found analyzing the correlation diagram, as these are more complex relationships, I'll be taking a look at them in the next part of this analysis:

* Unsurprisingly, the most correlated variables in the dataset are pH and Fixed Acidity (-0.68) as pH is a scale to measure the overall acidity of liquids. pH is also moderately correlated with citric acid (-0.54). The surprise here is that Volatile Acidity have an small positive effect on pH.

* According to the documentation that came with the dataset, Density should be strongly affected by Alcohol and Residual Sugar. While the first do present an expected "high" negative correlation (for the dataset, it's more like moderate as far as correlations go), Sugar exhibit a weaker relationship to Density (0.36, along with Citric Acid) than Fixed Acidity (0.67). This last variable actually has the strongest relationship with Density in the dataset.

* Another expected "high" correlated relationship is Total Sulfur Dioxide and Free Sulfur Dioxide (0.67).

* One surprising result is that Volatile Acidity is negatively correlated with Citric Acid (-0.55) and Fixed Acidity (-0.26). What is not surprising is that it has the biggest negative effect on Quality (-0.39) of all the variables, nobody likes wine that tastes like vinegar!

* A strange result is that Sulphates doesn't appear to be correlated with Total (0.04) and Free Sulfur Dioxide (0.05), as whole point of having it, it is an additive, is to increase the SO2 levels. One possible explanation for this is that Sulphates are only added to wines with poor naturally occurring levels of SO2, that would explain why Sulphates have a positive effect on Quality (0.25) too.


### What was the strongest relationship you found?

As stated in the previous question, pH and Fixed Acidity have the strongest relationship in the dataset.
Here's the top 5 most correlated variables:

1. pH and Fixed Acidity (-0.68)
2. Fixed Acidity and Density (0.67), Fixed Acidity and Citric Acid (0.67), Free and Total Sulfur Dioxide (0.67)
5. Volatile Acidity and Citric Acid (-0.55)

When talking about the Quality, Alcohol has the strongest relationship (0.48), followed by Volatile Acidity (-0.39)

***

# Multivariate Plots Section

In this section, we'll expand the analysis and try to figure out the relationships between many variables, starting with one exploration I've been willing to do since the start, density:

### Density

Here's the correlation values between density and all the variables:

```{r echo=FALSE}
sort(cor.matrix[,'density'], decreasing = TRUE)[2:12]
```

The strongest relationships are between it and Fixed Acidity (0.67) and Alcohol (-0.50):

```{r echo = FALSE}
p1 <- ggplot(data = data, aes(x = fixed.acidity, y = density)) + 
  geom_point(alpha = 0.1) +
  scale_y_continuous(trans = 'identity') +
  geom_smooth(method = 'loess')
p2 <- ggplot(data = data, aes(x = alcohol, y = density)) + 
  geom_point(alpha = 0.1) +
  scale_y_continuous(trans = 'identity') +
  geom_smooth(method = 'loess')
grid.arrange(p1, p2, ncol = 2)
```

The plot between them and density overlayed by a LOESS Regression illustrates the expected relationships.

The third most important variable is Residual Sugar(0.36):

```{r echo = FALSE}
p1 <- ggplot(data = data, aes(x = residual.sugar, y = density)) + 
  geom_point(alpha = 0.1) +
  scale_y_continuous(trans = 'identity') +
  geom_smooth(method = 'loess')
p2 <- ggplot(data = data, aes(x = residual.sugar, y = density)) + 
  geom_point(alpha = 0.1) +
  scale_y_continuous(trans = 'identity') +
  geom_smooth(method = 'loess') +
  scale_x_log10()
grid.arrange(p1, p2, ncol = 2)
```

The relationship seems exponential until around Residual Sugar = 4, and noisy afterwards, so applying a log10 transformation in the X axis the plot becomes clearer (Plot 2).


Next we'd have Citric Acid (0.36) and pH (-0.34), but they are both highly correlated with Fixed Acidity, so they don't show us much new information.

```{r echo = FALSE}
p1 <- ggplot(data = data, aes(x = citric.acid, y = density)) + 
  geom_point(alpha = 0.1) +
  scale_y_continuous(trans = 'identity') +
  geom_smooth(method = 'loess')
p2 <- ggplot(data = data, aes(x = pH, y = density)) + 
  geom_point(alpha = 0.1) +
  scale_y_continuous(trans = 'identity') +
  geom_smooth(method = 'loess')
grid.arrange(p1, p2, ncol = 2)
```

The study of pH and the variables that deal with acidity is next on the list.


Here's the best plot I could make to illustrate the relationship between Density and Fixed Acidity, Alcohol and Residual Sugar:

```{r echo = FALSE}
ggplot(data = data, aes(x = fixed.acidity, y = density, color = alcohol, 
                        size = residual.sugar)) + 
  geom_jitter(alpha = 0.3) +
  scale_color_distiller(palette = 'Spectral') +
  scale_y_continuous(trans = 'identity') +
  geom_smooth(method = 'loess') + 
  scale_x_log10(breaks = seq(0,100,1))
```

This plot shows the linear relationship between Fixed Acidity, the relationship is even more linear if we that the log10 of the X variable. The color of the dots represent the alcohol content, and the size, residual sugar, as the legends illustrates. There's a clear concentration of bigger dots at higher densities and higher alcohol content at lower ones.

### pH and acids

Again, let's start with the correlation values of pH:

```{r echo=FALSE}
sort(cor.matrix[,'pH'], decreasing = TRUE)[2:12]
```

The two variables with the strongest relationship are Fixed Acidity (-0.68) and Citric Acid (-0.54):

```{r echo = FALSE}
p1 <- ggplot(data = data, aes(x = fixed.acidity, y = pH)) + 
  geom_point(alpha = 0.1) +
  scale_y_continuous(trans = 'identity') +
  geom_smooth(method = 'loess')
p2 <- ggplot(data = data, aes(x = citric.acid, y = pH)) + 
  geom_point(alpha = 0.1) +
  scale_y_continuous(trans = 'identity') +
  geom_smooth(method = 'loess')
grid.arrange(p1, p2, ncol = 2)
```

The problem here is that both these variables are strongly correlated with one another (0.67):

```{r echo = FALSE}
p1 <- ggplot(data = data, aes(x = fixed.acidity, y = citric.acid)) + 
  geom_point(alpha = 0.1) +
  scale_y_continuous(trans = 'identity') +
  geom_smooth(method = 'loess')
p2 <- ggplot(data = data, aes(x = fixed.acidity, y = pH, color = citric.acid)) + 
  geom_point(alpha = 0.5) +
  scale_color_distiller(palette = 'Spectral') +
  scale_y_continuous(trans = 'identity') +
  geom_smooth(method = 'loess')
grid.arrange(p1, p2, ncol = 2)
```

Using them both doesn't bring much new information, but as this is a study of acidity, I should to use it. 


The next most correlated variable is density, even though we saw before that density is highly correlated with fixed acidity too, this variable can bring a lot of new information, mainly it's relationship with Alcohol and Residual Sugar, so it may be useful:

```{r echo = FALSE}
p1 <- ggplot(data = data, aes(x = density, y = pH)) + 
  geom_point(alpha = 0.1) +
  scale_y_continuous(trans = 'identity') +
  geom_smooth(method = 'loess')
p2 <- ggplot(data = data, aes(x = fixed.acidity, y = pH, color = density)) + 
  geom_point(alpha = 0.5) +
  scale_color_distiller(palette = 'Blues', direction = 0) +
  scale_y_continuous(trans = 'identity') +
  geom_smooth(method = 'loess')
grid.arrange(p1, p2, ncol = 2)
```

There's a concentration of lower dense data points below the regression line, so this could be useful, but I'll keep only acid-related variables in the final plot.

The last variable worth looking into is the most curious one, and the reason I wanted to look into pH, Volatile Acidity (0.23), as one would expect it to have a negative relationship with pH, as lower pH means a more acidic content, but the correlation says it's the opposite effect:

```{r echo = FALSE}
p1 <- ggplot(data = data, aes(x = volatile.acidity, y = pH)) + 
  geom_point(alpha = 0.1) +
  scale_y_continuous(trans = 'identity') +
  geom_smooth(method = 'loess')
p2 <- ggplot(data = data, aes(x = fixed.acidity, y = pH, color = volatile.acidity)) + 
  geom_point(alpha = 0.5) +
  scale_color_distiller(palette = 'Purples', direction = 0) +
  scale_y_continuous(trans = 'identity') +
  geom_smooth(method = 'loess')
grid.arrange(p1, p2, ncol = 2)
```

A very Small effect, but it's we can see that the points with the highest volatile acidity are located above the regression line.

Here's a curious plot illustrating all the acid-related variables:

```{r}
ggplot(data = data, aes(x = volatile.acidity, y = pH, size = fixed.acidity, 
                        color = citric.acid)) + 
  geom_point(alpha = 1) +
  scale_color_distiller(palette = 'Spectral', direction = -1) +
  scale_y_continuous(breaks = seq(0, 10, 0.1), trans = 'identity') +
  geom_smooth(method = 'loess')
```

The coordinates and the regression shows us the weak, but curious, positive relationship between pH and Volatile Acidity. The size and color scale represent Fixed Acidity and Citric Acid respectively. A curiosity: the wines with the highest pH have both low Citric Acid and low Fixed Acidity, but the most acidic wine (pH ~ 2.74) has just a a moderate amount of Fixed Acidity, but the highest amount of Citric Acid in the dataset.

### Quality and everything else

As we've already explored the relationship between all variables and quality, we can go ahead and plot the most correlated variables with quality together:

```{r echo=FALSE}
sort(cor.matrix[,'quality'], decreasing = TRUE)[2:12]
```

```{r echo=FALSE, warning=FALSE}
ggplot(data = data, aes(x = quality, y = alcohol, color = volatile.acidity, 
                        size = sulphates)) + 
  geom_jitter(alpha = 0.7) +
  scale_color_distiller(palette = 'Spectral', direction = -1) +
  scale_y_continuous(trans = 'identity', breaks = seq(0, 100, 0.5)) +
  scale_x_continuous(breaks = seq(0, 10, 1)) +
  geom_smooth(method = 'loess', color = 'black')
```

In this plot we can observe how the these variables affect quality, and there's some interesting new conclusions we can make:

* No good wine have a high value of Volatile Acidity.

* The wine with the most alcohol content is of quality 5, the other variables, Sulphates and Volatile Acidity, are within range of a much better wine. This illustrates that even with all this information, it's hard to predict the quality of a wine taking into account just the chemical composition.

This last point is the reason that using an linear model to estimate the quality ultimately fails:


```{r echo=FALSE, warning=FALSE}

m1 <- lm(quality ~ alcohol, data = data)
m2 <- update(m1, ~ . + volatile.acidity)
m3 <- update(m2, ~ . + sulphates)
m4 <- update(m3, ~ . + citric.acid)
m5 <- update(m4, ~ . + total.sulfur.dioxide)
m6 <- update(m5, ~ . + density)
m7 <- update(m6, ~ . + chlorides)
mtable(m1, m2, m3, m4, m5, m6, m7, sdigits = 3)
```

The 7 most correlated variables just account for 35.2% of the quality rating.
Here's the regression line against a 3 fold cross validation:

```{r echo=FALSE, warning=FALSE}
cv.lm(data = data, m7, m=3, printit = FALSE)
```

Trying to predict an ordered factor variable using a linear regression will never yields good results.


Using a classifier, instead, makes more sense, so we need to split the dataset into training and testing:

```{r echo=FALSE}
set.seed(42)
indexes <- sample(1599, 1200)
train <- data[indexes,]
test <- data[-indexes,]
print('Training set:')
dim(train)
print('Testing set:')
dim(test)
```



Here's the performance of a SVM classifier, using all the variables, already tuned:

```{r echo=FALSE}
formula <- quality ~ alcohol + volatile.acidity + sulphates + citric.acid + 
  total.sulfur.dioxide + density + chlorides + fixed.acidity + pH + 
  free.sulfur.ppm + residual.sugar
svm.model <- svm(formula, data = train, kernel='radial', type='C-classification', 
                 cost = 4, gamma = 0.4)

svm.pred  <- predict(svm.model, test[,-13-14])
cm <-table(true = test[,13], predicted = svm.pred)
diag = diag(cm)
rowsums = apply(cm, 1, sum) # number of instances per class
colsums = apply(cm, 2, sum) # number of predictions per class
precision = diag / colsums 
recall = diag / rowsums 
f1 = 2 * precision * recall / (precision + recall)
res <- data.frame(precision, recall, f1)
accuracy <- sum(diag(cm))/sum(cm)
svm.model
cat("Accuracy:", accuracy*100, "%")
```

67.4% of accuracy is not that great, but still way better than random guess. A better way to analyse this model is using a confusion matrix and precision, recall and F1 scores:

```{r echo=FALSE}
cm
res
```

At least no good wine was classified as bad, and no bad wine was classified as good. Most predictions were pretty close to what the real value was. 

If instead of trying to predict the exact score, we ask the model to predict if a wine is below or above average, a buy or not classification, we should buy only wines of above average quality, greater than 5:

```{r echo=FALSE}
data$buy <- cut(data$quality, breaks = c(0,5,10), labels = c('No', 'Yes'))
table(data$buy)
```

This way the dataset is split pretty evenly, a great characteristic for fitting machine leaning models.

```{r echo=FALSE, warning=FALSE}
ggplot(data = data, aes(x = volatile.acidity, y = alcohol, color = buy)) + 
  geom_point(alpha = 0.7) +
  scale_color_brewer(palette = 'Dark2', direction = -1) +
  scale_y_continuous(trans = 'identity', breaks = seq(0, 100, 0.5)) +
  scale_x_continuous(breaks = seq(0, 10, 0.10))
```

We should never buy wines with Volatile Acidity above 1.05, and the greater the alcohol content is, the more likely we are to buy it.

Now, the SVM classifier:

```{r echo=FALSE}
set.seed(42)
indexes <- sample(1599, 1200)
train <- data[indexes,]
test <- data[-indexes,]
formula <- buy ~ alcohol + volatile.acidity + sulphates + citric.acid + 
  total.sulfur.dioxide + density + chlorides + fixed.acidity + pH + 
  free.sulfur.ppm + residual.sugar
svm.model <- svm(formula, data = train, kernel='radial', type='C-classification', 
                 cost = 10, gamma = 0.6)
svm.pred  <- predict(svm.model, test[,-15-14-13])
cm <-table(true = test[,15], predicted = svm.pred)
diag = diag(cm)
rowsums = apply(cm, 1, sum) # number of instances per class
colsums = apply(cm, 2, sum) # number of predictions per class
precision = diag / colsums 
recall = diag / rowsums 
f1 = 2 * precision * recall / (precision + recall)
res <- data.frame(precision, recall, f1)
accuracy <- sum(diag(cm))/sum(cm)
svm.model
cat("Accuracy:", accuracy*100, "%")
cm
res
```

This classifier can recommend if you should buy the wine or not with over 80% precision, a pretty cool end result for this analysis!

*** 

# Multivariate Analysis

### Talk about some of the relationships you observed in this part of the investigation. Were there features that strengthened each other in terms of looking at your feature(s) of interest?

As I had already explored in depth the relationship between each variable and quality, I chose to focus on the relationship between them in this section.

The study of density illustrated why it had a negative impact on quality, it was negatively correlated with the two main positive variables when talking about quality, alcohol and citric acid.

I've studied the relationship of pH and the acid related variables in the dataset too. This analysis found an interesting counter intuitive positive correlation between it and volatile acidity. As expected, the other acidic variables (fixed acidity and volatile acidity) had a negative effect on the pH value. Density had a negative effect too, but it can be explained when we look into the study of it, fixed acidity, the most negatively correlated variable with pH, is the of the most positively correlated variables with density, so no surprises here.

In this section I explored the most correlated variables to quality together, creating a plot to illustrate this, with these findings, I proceeded into the creation of predictive models to find out if it would be possible to mathematically predict quality based on the available variables. More on that in the final question's answer.

### Were there any interesting or surprising interactions between features?

Intuition led me to believe that Volatile Acidity, the amount of acetic acid (vinegar taste), would have a negative correlation with pH, as the pH of this acid is 2.4 and all the wines have a value above it. But that was not the case, they were positively correlated, albeit only slightly, which is a strange behavior that I cannot explain.

### OPTIONAL: Did you create any models with your dataset? Discuss the strengths and limitations of your model.

Yes, the linear model was created from the most important dependent variable, alcohol, it accounted for 22.7 % of the variance in quality. Adding volatile acidity helped the model to explain over 30% of the variance (r^2 = 0.317), but adding even more variables had a diminishing return after the third one, sulphates (r^2 = 0.336). The final model, with 7 variables only accounted for 35.2% of the variance in quality.

Obviously, as quality, while a numeric in nature, is an ordered factor with fixed integer values, a linear regression is not the best model to predict its value. So I created a SVM classifier. Using all the available variables in the dataset, it was able to reach 67.4 % of accuracy, but an analysis of the precision, recall and F1 scores clarified why: Most of the wines are of 5 or 6 quality, so predicting those values would ensure an acceptable level of accuracy, even for a poor model.

Expanding on these findings, I chose to create yet another output variable, as using the previously created quality.bins would have the same issues explained in the previous paragraph. The new variable called 'buy' has 2 possible values, Yes for wines of quality 6 and above and No for 5 and below. The almost even distributions of the data points between these values ensures that the accuracy score of the model would not benefit from the tall normal distribution of quality (most wines are average, quality = 5 or 6).

The end result was satisfactory, as the model was able to predict correctly in 82% of the cases, which let to me conclude that while the chemical composition can't be used to predict an exact value for the quality of a wine, it does have a pronounced effect. Better wines have a different composition that worse ones.

This conclusion inspired me to the build the third plot below, where we can see the difference in composition of the best (quality = 7 and 8) and the worst wines (quality = 3 and 4).

***

# Final Plots and Summary

### Plot one

```{r echo=FALSE}
ggplot(aes(quality, fill = quality.bins), data = data) +
  geom_histogram(bins = 6, color = 'black') +
  scale_x_continuous(breaks = seq(1, 10, 1)) +
  scale_y_continuous(breaks = seq(0, 700, 50)) +
  labs(x = 'Quality', y = 'Number of Wines', title = 'Distribution of Wines by Quality',
       fill = 'Quality Groups')
```


### Description One

Quality is normally distributed, most wines have a score of 5 or 6 (over 625 wines each) and are grouped together in the green group. There's fewer 'worst' (red) wines than 'best' (blue).

This plot helps the general public to familiarize themselves with the Quality Groups and the distribution of quality, making the other plots easier to understand.

### Plot Two

```{r echo=FALSE}
means$Quality <- means$quality.bins
ggRadar(data = means, aes(fill = Quality), rescale = FALSE, size = 1.5, 
        ylim = c(0, 1)) +
  labs(title = 'Mean of Variables and Quality Groups')
  
```

### Description Two

The radar plot of the means of each variable (scaled between 0.5 and 1), separated by the quality groups helps to visually identify the profile of the different Quality Groups:

* Positive effect - Variables that tend to increase the quality of the wines as they increase:
    + Fixed Acidity
    + Citric Acid
    + Sulphates
    + Alcohol
    
* Negative effect - Variables that tend to have the opposite effect, decreasing the quality of the wine as they increase:
    + Volatile Acidity
    + Chlorides
    + pH
    
* Undetermined effect - Variables with a more complicated relationship:
    + Residual Sugar
    + Free Sulfur Dioxide (ppm)
    + Total Sulfur Dioxide
    + Density
    
Even losing dimensionality information, this plot was a key first step into understanding the relationship between each variable and quality.

### Plot Three

```{r echo=FALSE}
ggplot(data = subset(data, quality.bins != 'average'), aes(x = alcohol, 
                                                           y = volatile.acidity, 
                                                           color = quality.bins, 
                                                           size = sulphates)) + 
  geom_jitter(alpha = 0.7) +
  scale_y_continuous(breaks = seq(0, 2, 0.1)) +
  scale_x_continuous(breaks = seq(0, 14, 0.5)) +
  labs(title = 'Profile of the Best and Worst Wines', y = 'Volatile Acidity (g/L)',
       x = 'Alcohol Content (% vol)', size = 'Sulphates (g/L)', 
       color = 'Quality Groups') 
```

### Description Three

The three variables that better explain wine quality in this dataset are, from most important to the least:

* *Alcohol Content*: The variable with the most positive effect on quality (Correlation = 0.48)
* *Volatile Acidity*: The opposite of Alcohol, this variable has the most negative effect (Correlation = -0.39)
* *Sulphates*: This is an additive used on the production of the wines to make sure it has a healthy level of sulfur dioxide (SO2), this is important because it has antioxidant and antimicrobial proprieties (Correlation = 0.25)

In this plot, all average wines are omitted to emphasize the difference of composition between the worst and the best wines in the dataset. There's no good wine with over 1.0 g/L of volatile acidity, and very few bad wines with over 11.5% alcohol. The effect of the addition of sulphates is less clear, but looking closely it's possible to conclude that a good wine needs at least some of this additive.

# Reflection

With 1599 different wines, this was a great dataset to explore. In the begging of the exploration, I took a look at each variable to better understand its distribution, most variables were normally distributed, with a few exceptions. Still in the first part of the analysis, I chose to separate the data points into 3 bins hoping to easily identify the relationship of the variables. The trends identified helped shape the second section of the exploration.

In the second part I took an in depth look at the relationship between each variable and quality. Using the correlation score, some previous findings were confirmed, while a few remained a mystery. Potting box plots of each one of them against quality and breaking up the groups I created previously helped to precisely understand how and how much each of them affected the quality score. In this section I learned that there were data points all over the place, no nice and linear relationship could be found, so a linear model to predict quality would be pretty hard to implement.

The last part was all about how one variable could influence another, not only quality. I studied how the density and the pH were affected by the other variables, this helped better understand why density had a complicated relationship with quality. The study of pH, while unrelated with the objective of this project, showed the most curious relationship found in this dataset, the one between it and volatile acidity.

Returning to the main objective, I plotted the relationship between quality and the variables that had the greatest effect on it together and tried to create a linear model maybe would help to predict it. It failed. The reason for it became evident once I plotted the result of a cross validation: using a simple linear regression to predict an ordered factor is not a good practice and the dataset has a huge concentration of average wines, so any classification model would benefit from a highly inflated accuracy score, while precision and recall scores suffered. 

I created an SVM classifier to illustrate this last point. And, finally, created a model that yielded good results. I had to split the dataset once again, but this time between above and below average, and using the available variables, it could predict which group the wine belonged with 82% accuracy! This illustrates that while chemical composition is not a great way guess the precise quality of a wine, it does have an pronounced and real effect on it.

Limitations of this analysis are the facts that the quality scores are a bit subjective, even using a median of at least 3 scores given by experts, it's not a concrete value, like price, for example, and that all the data was from only just one winery. This last point is open to debate as fixing an independent variable (winery) helps to reduce variability, but not having another dataset, from other winery, leaves a question: do theses results apply to any winery, or specifically to this one? An idea for another project!